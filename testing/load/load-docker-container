#!/usr/bin/env bash
#
# Loads image tarballs (such as those generated by the 'maketar' script) into Docker
# Registry running as a container. Usage (e.g.):
#
# ./load-docker-container ~/tmp/testfiles --start-docker --load-images
#
# The script runs docker on http so make sure to add the registry
# container to /etc/docker/daemon.json. E.g.:
#
# cat <<EOF | sudo tee /etc/docker/daemon.json
# {
#     "insecure-registries" : [
#       "ubuntu.me:5000"
#     ]
# }
# EOF
#
# ubuntu.me is hard-coded into the script which supports my test environment.

set -e

start_docker=0
load_images=0
cleanup=0
tarfile_dir=

for opt in "$@"; do
  if [[ $opt == "--start-docker" ]]; then
    start_docker=1
  elif [[ $opt == "--load-images" ]]; then
    load_images=1
  elif [[ $opt == "--cleanup" ]]; then
    cleanup=1
  elif [[ -z "$tarfile_dir" ]]; then
    tarfile_dir=$opt
    if [[ ! -d $tarfile_dir ]]; then
      echo "not a directory: $tarfile_dir"
      exit 1
    fi
  else
    echo "unable to part command line option: $opt"
    exit 1
  fi
done

if [[ $start_docker -eq 1 ]]; then
  docker run\
    --name registry\
    --detach\
    --publish 5000:5000\
    docker.io/registry:3.0.0
fi

my_docker_registry_container="ubuntu.me:5000"

if [[ $load_images -eq 1 ]]; then
  ls -1 $tarfile_dir/*.tar | while read tarfile; do
    docker load -i $tarfile
    image=$(basename $tarfile)
    image=${image%.*}
    docker tag $image $my_docker_registry_container/$image
    docker push $my_docker_registry_container/$image
  done
fi

if [[ $cleanup -eq 1 ]]; then
  docker stop registry
  docker container rm registry
fi
