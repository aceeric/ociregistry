#!/usr/bin/env bash
#
# maketar is a helper script to make docker image tarballs that can be loaded into a
# local docker registry, and that the ociregistry can pull through from. This enables
# volume testing without having to pull from actual registries like quay or dockerhub.
# The images generated by the script can't be used for anything except load and volume
# testing the ociregistry server.
# 
# The images are named (tagged) with two random 10-position alphanum name parts, then a
# 4-digit segment suffix, then a major:minor tag consisting of random numbers. E.g.:
# 
# wu0dnetv4s-597p54o2q8-0001:v494.843
#
# Each image has 5 layers (hard-coded). You specify the layer sizes on the command line
# to suport testing different blob sizes. E.g.: 42,123456,10K,30M,1.2G.
#
# The script adds files to the target directory on each run. If you want a clean start
# then remove the target directory before running the script.

set -e

if [[ "$#" -ne 4 ]]; then
  echo "usage: maketar <tar count> <segment count> <blob sizes> <dest dir>, e.g.: ./maketar 200 5 50K,200K,1M,3M,20M ~/tmp/testfiles"
  exit 1
fi

config='{"architecture":"amd64","config":{"Env":["PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"],"Cmd":["/hello"],"WorkingDir":"/"},"created":"2025-08-08T19:05:17Z","history":[{"created":"2025-08-08T19:05:17Z","created_by":"COPY hello / # buildkit","comment":"buildkit.dockerfile.v0"},{"created":"2025-08-08T19:05:17Z","created_by":"CMD [\"/hello\"]","comment":"buildkit.dockerfile.v0","empty_layer":true}],"os":"linux","rootfs":{"type":"layers","diff_ids":[LAYERDIFFIDS]}}'

manifest='
[
   {
      "config": "sha256:CONFIGSHA",
      "repoTags": [
         "IMAGENAME:vTAG"
      ],
      "layers": [
         LAYERS
      ]
   }
]'

image_count=$1
segment_count=$2
IFS=',' read -r -a layer_sizes <<< "$3"
target_dir=$4
layer_count=5
segment_boundary=$((image_count / segment_count))

if [[  ${#layer_sizes[@]} -ne $layer_count ]]; then
  echo "number of layer sizes must equal $layer_count"
fi

# convert "10K" to "10240"
for (( i = 0; i < ${#layer_sizes[@]}; i++)); do
  layer_sizes[$i]=$(echo ${layer_sizes[$i]} | numfmt --from=iec)
done

# debug
# echo "image_count=$image_count"
# echo "segment_count=$segment_count"
# echo "layer_sizes=${layer_sizes[@]}"
# echo "target_dir=$target_dir"
# echo "layer_count=$layer_count"
# echo "segment_boundary=$segment_boundary"
# exit

mkdir -p $target_dir/image

cur_segment=1
cur_image=1
while [[ $cur_image -le $image_count ]]; do
  rm -f $target_dir/image/*

  # create image name and tag
  part1=$(head /dev/urandom | tr -dc a-z0-9 | head -c 10)
  part2=$(head /dev/urandom | tr -dc a-z0-9 | head -c 10)
  segment_val=$(printf '%04d' $cur_segment)
  imagename="$part1-$part2-$segment_val"
  imagetag="${RANDOM:1:3}.${RANDOM:1:3}"

  # progress echo
  echo "$imagename:v$imagetag ($cur_image of $image_count)"

  # create layers (hardcoded layer count)
  layer=1
  while [[ $layer -le $layer_count ]]; do
    layer_size=${layer_sizes[$((layer - 1))]}
    < /dev/urandom LC_ALL=C tr -dc '[:print:]' | head -c $layer_size >| $target_dir/layer_content
    pushd $target_dir &>/dev/null
    tar -cf $target_dir/image/TEMP.tar layer_content
    popd &>/dev/null
    layersha=$(sha256sum $target_dir/image/TEMP.tar | awk '{print $1}')
    mv $target_dir/image/TEMP.tar $target_dir/image/$layersha.tar
    ((++layer))
  done

  # create layer and diff id content to interpolate into manifest.json and
  # the config layer
  diff_ids=""
  layers=""
  diffsep=""
  layersep=""

  while IFS= read layer; do
    layer=$(basename $layer)
    diff_ids="${diff_ids}${diffsep}\"sha256:${layer%.*}\""
    layers="${layers}${layersep}\"$layer\""
    diffsep=", "
    layersep=",\n         "
  done < <(ls $target_dir/image/*.tar)

  # generate the config layer
  echo "$config" | sed -e "s/LAYERDIFFIDS/$diff_ids/" > $target_dir/image/TEMP
  configsha=$(sha256sum $target_dir/image/TEMP | awk '{print $1}')
  mv $target_dir/image/TEMP $target_dir/image/sha256:$configsha

  # generate manifest.json
  echo "$manifest" | sed\
    -e "s/LAYERS/$layers/"\
    -e "s/CONFIGSHA/$configsha/"\
    -e "s/IMAGENAME/$imagename/"\
    -e "s/TAG/$imagetag/"\
    > $target_dir/image/manifest.json

  # create the tar - it can be loaded into docker, e.g. docker load -i wu0dnetv4s-597p54o2q8-0001:v494.843.tar
  pushd $target_dir/image &>/dev/null
  tar -cf ../$imagename:v$imagetag.tar *
  popd &>/dev/null
  ((++cur_image))

  # increment segment
  if [[ $segment_boundary -gt 0 ]]; then
    mod=$((cur_image % segment_boundary))
    if [[ $mod -eq 0 ]]; then
      ((++cur_segment))
    fi
  fi
done
